{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SMS Dashboard | Beloved Church Kenya</title>
  <link rel="stylesheet" href="{% static 'smsapp/css/dashboard.css' %}">
</head>
<body>

<!-- Navbar -->
<nav class="navbar">
    <a href="{% url 'smsapp:dashboard' %}">Dashboard</a>
    <a href="{% url 'smsapp:upload_contacts' %}">Upload</a>
    <img src="{% static 'media/logo.jpg' %}" alt="Beloved Church Logo" class="logo-navbar">

    {% if user.is_staff %}
    <button id="show-balance" class="btn btn-info">
        Bal: <span class="balance-amount">Ksh {{ celcom_balance.credit|floatformat:2 }}</span>
    </button>
    {% endif %}

    <button id="show-smslogs" class="btn btn-primary">SMS Logs</button>

    {% if user.is_authenticated %}
        <a href="{% url 'accounts:logout' %}">Logout</a>
    {% else %}
        <a href="{% url 'accounts:login' %}">Login</a>
    {% endif %}
</nav>

{% if user.is_authenticated and user.is_admin %}
<button id="show-user-management" class="btn btn-warning">Manage Users</button>
<div id="user-action-msg" style="margin:10px 0; color:green;"></div>
{% endif %}

<!-- SMS Logs -->
<div id="smslogs-section" class="smslogs-card" style="display:none;">
    <h3>SMS Logs</h3>
    <div class="table-wrapper">
        <table class="smslogs-table">
            <thead>
                <tr>
                    <th>Sender</th>
                    <th>Message</th>
                    <th>Recipient</th>
                    <th>Status</th>
                    <th>Sent At</th>
                </tr>
            </thead>
            <tbody>
                {% for log in sms_logs %}
                <tr>
                    <td>{{ log.sender.username }}</td>
                    <td>{{ log.message }}</td>
                    <td>{{ log.recipients }}</td>
                    <td>{{ log.status }}</td>
                    <td>{{ log.sent_at|date:"d M Y H:i" }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="no-logs">No SMS logs yet.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- User Management Table -->
<div id="user-management-section" style="display:none;">
    <h3>Admin User Management</h3>
    <table border="1" id="users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Bulk SMS -->
<div class="dashboard-box">
    <h2>Send Bulk SMS</h2>
    <div class="tabs">
      <button type="button" class="tab-btn" data-category="Regional">Regional</button>
      <button type="button" class="tab-btn" data-category="Subregional">Subregional</button>
      <button type="button" class="tab-btn" data-category="Pastor">Pastor</button>
    </div>
    <div id="recipientsContainer"></div>

    {% if result %}
      <p class="msg success">{{ result }}</p>
    {% endif %}

    <form method="post" id="smsForm">
      {% csrf_token %}
      <input type="hidden" name="category" id="selectedCategory">
      <div id="dynamicRecipients"></div>
      <textarea name="message" id="message" rows="5" placeholder="Type your message..." required></textarea>
      <button type="submit" id="sendSmsBtn">Send SMS</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {

  // =======================
  // Bulk SMS Tab Handling
  // =======================
  const tabs = document.querySelectorAll('.tab-btn');
  const categoryInput = document.getElementById('selectedCategory');
  const form = document.getElementById('smsForm');
  const messageInput = document.getElementById('message');
  const sendBtn = document.getElementById('sendSmsBtn');
  const recipientsContainer = document.getElementById('recipientsContainer');

  const categoryMap = {
    'Regional': 'Regional Overseer',
    'Subregional': 'Subregional Pastor',
    'Pastor': 'Pastor'
  };

  function fetchContacts(tabCategory) {
    fetch(`/get_pastors/?category=${encodeURIComponent(categoryMap[tabCategory])}`)
      .then(res => res.json())
      .then(data => renderRecipients(tabCategory, data.pastors || []))
      .catch(err => console.error("Error fetching contacts:", err));
  }

  function renderRecipients(tabCategory, contacts) {
    recipientsContainer.innerHTML = '';
    if(contacts.length === 0){
      recipientsContainer.textContent = "No contacts available for this category.";
      return;
    }

    // Filter strictly based on tab
    contacts = contacts.filter(c => c.category === categoryMap[tabCategory]);


    // Group contacts by region/subregion
    const grouped = {};
    contacts.forEach(c => {
      const region = c.region || 'No Region';
      const subregion = c.subregion || 'No Subregion';
      grouped[region] = grouped[region] || {};
      grouped[region][subregion] = grouped[region][subregion] || [];
      grouped[region][subregion].push(c);
    });

    // Tab-level Select All
    const tabSelectDiv = document.createElement('div');
    tabSelectDiv.style.marginBottom = '10px';
    const tabCheckbox = document.createElement('input');
    tabCheckbox.type = 'checkbox';
    tabCheckbox.style.marginRight = '5px';
    tabCheckbox.addEventListener('change', function(){
      recipientsContainer.querySelectorAll('input.contact-checkbox').forEach(cb => cb.checked = this.checked);
    });
    tabSelectDiv.appendChild(tabCheckbox);
    tabSelectDiv.appendChild(document.createTextNode('Select All Contacts in this Tab'));
    recipientsContainer.appendChild(tabSelectDiv);

    // Render grouped contacts
    for(const region in grouped){ 
      const regionDiv = document.createElement('div');
      regionDiv.style.marginBottom = '10px';
      const regionHeader = document.createElement('strong');
      regionHeader.textContent = region;
      regionDiv.appendChild(regionHeader);

      for(const subregion in grouped[region]){
        const subDiv = document.createElement('div');
        subDiv.style.marginLeft = '20px';
        subDiv.style.marginBottom = '5px';
        const subHeader = document.createElement('em');
        subHeader.textContent = subregion;
        subDiv.appendChild(subHeader);

        if(tabCategory === 'Pastor'){
          const subSelectDiv = document.createElement('div');
          const subCheckbox = document.createElement('input');
          subCheckbox.type = 'checkbox';
          subCheckbox.style.marginRight = '5px';
          subCheckbox.addEventListener('change', function () {
            subDiv.querySelectorAll('input.contact-checkbox').forEach(cb => cb.checked = this.checked);
          });
          subSelectDiv.appendChild(subCheckbox);
          subSelectDiv.appendChild(document.createTextNode('Select All in this Subregion'));
          subDiv.appendChild(subSelectDiv);
        }

        grouped[region][subregion].forEach(c => {
          const label = document.createElement('label');
          label.style.display = 'block';
          label.style.margin = '2px 0';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.classList.add('contact-checkbox');
          checkbox.name = 'recipients';
          checkbox.value = c.phone || '';
          label.appendChild(checkbox);
          label.appendChild(document.createTextNode(` ${c.name} (${c.phone})`));
          subDiv.appendChild(label);
        });

        regionDiv.appendChild(subDiv);
      }
      recipientsContainer.appendChild(regionDiv);
    }
  }

  // Auto-select first tab
  if(tabs.length > 0){
    const firstTab = tabs[0];
    firstTab.classList.add('selected');
    categoryInput.value = firstTab.dataset.category;
    fetchContacts(firstTab.dataset.category);
  }

  tabs.forEach(tab => tab.addEventListener('click', () => {
    categoryInput.value = tab.dataset.category;
    tabs.forEach(t => t.classList.remove('selected'));
    tab.classList.add('selected');
    fetchContacts(tab.dataset.category);
  }));


  // Form submit validation
  form.addEventListener('submit', function(e){
    e.preventDefault();  // prevent default form submission

    // Grab checked boxes from recipientsContainer
    const checkedBoxes = recipientsContainer.querySelectorAll('input.contact-checkbox:checked');
    const recipients = Array.from(checkedBoxes).map(cb => cb.value);

    if(!categoryInput.value){
        alert("Please select a category before sending the message.");
        return;
    }
    if(recipients.length === 0){
        alert("Please select at least one recipient before sending.");
        return;
    }
    if(!messageInput.value.trim()){
        alert("Please type a message before sending.");
        messageInput.focus();
        return;
    }

    // Disable button while sending
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    // Optional: send via AJAX
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch('/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            category: categoryInput.value,
            message: messageInput.value.trim(),
            recipients: recipients
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.result?.message || "SMS sent successfully!");
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send SMS';
        messageInput.value = '';
        checkedBoxes.forEach(cb => cb.checked = false);
    })
    .catch(err => {
        console.error(err);
        alert("Error sending SMS. Check console for details.");
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send SMS';
    });
});


  // =======================
// User Management
// =======================
const userBtn = document.getElementById('show-user-management');
const userSection = document.getElementById('user-management-section');
const msgDiv = document.getElementById('user-action-msg');

userBtn?.addEventListener('click', function() {
    userSection.style.display = userSection.style.display === 'none' ? 'block' : 'none';
    fetchUsers();
});

async function fetchUsers(){
    try {
        const response = await fetch("{% url 'accounts:admin_users_list' %}");
        const data = await response.json();
        const tbody = document.querySelector("#users-table tbody");
        tbody.innerHTML = '';

        const users = data.users || [];

        users.forEach(user => {
            const tr = document.createElement('tr');
            const statusColor = user.status === 'approved' ? 'green' : user.status === 'disabled' ? 'red' : 'orange';

            let actions = '';

            // Pending users: Approve or Reject
            if(user.status === 'pending') {
                actions += `<button onclick="updateStatus(${user.id}, 'approve')">Approve</button> `;
                actions += `<button onclick="updateStatus(${user.id}, 'reject')">Reject</button>`;
            }
            // Approved users: Disable if not admin
            else if(user.status === 'approved') {
                if(!user.is_admin) {
                    actions += `<button onclick="updateStatus(${user.id}, 'disable')">Disable</button>`;
                }
            }
            // Disabled users: Enable
            else if(user.status === 'disabled') {
                actions += `<button onclick="updateStatus(${user.id}, 'enable')">Enable</button>`;
            }

            tr.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td style="color:${statusColor}">${user.status}</td>
                <td>${actions}</td>
            `;
            tbody.appendChild(tr);
        });

    } catch(err) {
        console.error("Error fetching users:", err);
        msgDiv.textContent = "Failed to load users. Please try again.";
        msgDiv.style.color = 'red';
    }
}

window.updateStatus = async function(userId, action){
    try {
        const response = await fetch("{% url 'accounts:user_status' %}",{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "X-CSRFToken":"{{ csrf_token }}"
            },
            body:JSON.stringify({user_id:userId, action:action})
        });

        const data = await response.json();

        msgDiv.textContent = data.status || "Action completed";
        msgDiv.style.color = (action === 'disable' || action === 'reject') ? 'red' : 'green';

        // Refresh the user table after action
        fetchUsers();
    } catch(err) {
        console.error("Error updating user status:", err);
        msgDiv.textContent = "Failed to update user status.";
        msgDiv.style.color = 'red';
    }
};

  // =======================
  // SMS Logs & Balance Toggle
  // =======================
  const balanceBtn = document.getElementById('show-balance');
  const smslogsBtn = document.getElementById('show-smslogs');
  const balanceSection = document.getElementById('balance-section');
  const smslogsSection = document.getElementById('smslogs-section');

  balanceBtn?.addEventListener('click', ()=> {
    if(balanceSection) balanceSection.style.display = balanceSection.style.display==='none'?'block':'none';
    if(smslogsSection) smslogsSection.style.display='none';
  });

  smslogsBtn?.addEventListener('click', ()=> {
    if(smslogsSection) smslogsSection.style.display = smslogsSection.style.display==='none'?'block':'none';
    if(balanceSection) balanceSection.style.display='none';
  });

});
</script>

</body>
</html>
