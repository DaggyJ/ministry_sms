{% extends "accounts/base_auth.html" %}
{% block content %}
<div class="col-md-5 mx-auto card p-4 shadow">
  <h3 class="text-center mb-3">Set New Password</h3>

  <form id="setNewPasswordForm" method="post">
    {% csrf_token %}
    <div class="mb-3">
      <label>New Password</label>
      <input type="password" name="new_password1" class="form-control" required>
    </div>
    <div class="mb-3">
      <label>Confirm Password</label>
      <input type="password" name="new_password2" class="form-control" required>
    </div>
    <button type="submit" class="btn btn-primary w-100">Reset Password</button>
  </form>

  <div id="passwordError" class="text-danger mt-2"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const form = document.getElementById("setNewPasswordForm");
  const errorDiv = document.getElementById("passwordError");

  form.addEventListener("submit", function(e) {
    e.preventDefault();
    errorDiv.textContent = "";

    const formData = new FormData(form);

    fetch("{% url 'accounts:set_new_password' %}", {
      method: "POST",
      headers: {"X-Requested-With": "XMLHttpRequest"},
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert(data.message);
        window.location.href = data.redirect_url;
      } else {
        if (data.errors) {
          errorDiv.innerHTML = Object.values(data.errors).map(arr => arr.join('<br>')).join('<br>');
        } else {
          errorDiv.textContent = data.error || "Validation failed";
        }
      }
    })
    .catch(err => {
      console.error(err);
      errorDiv.textContent = "An unexpected error occurred.";
    });
  });
});
</script>
{% endblock %}
